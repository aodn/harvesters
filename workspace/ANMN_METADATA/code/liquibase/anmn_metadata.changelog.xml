<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet author="talend" id="global_attribute_table">
      <sql>
        CREATE TABLE global_attribute 
        (
          file_id bigint NOT NULL,
          name text NOT NULL,
          type text,
          value text,
          CONSTRAINT global_attribute_pk PRIMARY KEY (file_id, name),
          CONSTRAINT global_attribute_file_fk FOREIGN KEY (file_id)
              REFERENCES indexed_file (id) MATCH SIMPLE
              ON UPDATE CASCADE ON DELETE CASCADE
        );
      </sql>
    </changeSet>


    <changeSet author="talend" id="variable_table">
      <sql>
        CREATE TABLE variable
        (
          file_id bigint NOT NULL,
          name text NOT NULL,
          type text,
          dimensions text,
          shape text,
          CONSTRAINT variable_pk PRIMARY KEY (file_id, name),
          CONSTRAINT variable_file_fk FOREIGN KEY (file_id)
              REFERENCES indexed_file (id) MATCH SIMPLE
              ON UPDATE CASCADE ON DELETE CASCADE
        );
      </sql>
    </changeSet>


    <changeSet author="talend" id="variable_attribute_table">
      <sql>
        CREATE TABLE variable_attribute 
        (
          file_id bigint NOT NULL,
          container text NOT NULL,
          name text NOT NULL,
          type text,
          value text,
          CONSTRAINT variable_attribute_pk PRIMARY KEY (file_id, container, name),
          CONSTRAINT variable_attribute_file_fk FOREIGN KEY (file_id)
              REFERENCES indexed_file (id) MATCH SIMPLE
              ON UPDATE CASCADE ON DELETE CASCADE
        );
      </sql>
    </changeSet>


    <changeSet author="talend" id="file_metadata_table">
      <sql>
        CREATE TABLE file_metadata 
        (
          id bigserial PRIMARY KEY,
          file_id bigint UNIQUE NOT NULL,
          feature_type text,
          file_version text,
          toolbox_version text,
          compliance_checker_version text,
          compliance_checker_last_updated timestamp with time zone,
          compliance_checks_passed text,
          site_code text,
          platform_code text,
          deployment_code text,
          instrument text,
          instrument_serial_number text,
          instrument_nominal_depth text,
          geospatial_vertical_min double precision,
          geospatial_vertical_max double precision,
          date_created timestamp with time zone,
          time_coverage_start timestamp with time zone,
          time_coverage_end timestamp with time zone,
          time_deployment_start timestamp with time zone,
          time_deployment_end timestamp with time zone,
          latitude double precision,
          longitude double precision,
          geom geometry(Geometry,4326) CHECK (st_isvalid(geom)),
          data_category text,
          variables text,
          standard_names text,
          realtime boolean,
          deleted boolean,
          CONSTRAINT file_metadata_file_fk FOREIGN KEY (file_id)
              REFERENCES indexed_file (id) MATCH SIMPLE
              ON UPDATE CASCADE ON DELETE CASCADE
        );

        CREATE INDEX file_metadata_gist_idx ON file_metadata USING GIST (geom); 
      </sql>
    </changeSet>


    <changeSet author="talend" id="add_toolbox_input_file_column">
      <sql>
        ALTER TABLE file_metadata
          ADD COLUMN toolbox_input_file text ;

        UPDATE file_metadata m
          SET toolbox_input_file = getglobalattribute(file_id, 'toolbox_input_file') ;
      </sql>
    </changeSet>


    <changeSet author="talend" id="add_deployment_number_column">
      <sql>
        ALTER TABLE file_metadata
          ADD COLUMN deployment_number text ;

        UPDATE file_metadata m
          SET deployment_number = getglobalattribute(file_id, 'deployment_number') ;
      </sql>
    </changeSet>


    <changeSet author="talend" id="moorings_all_map" runOnChange="true">
      <sql>
        DROP VIEW IF EXISTS current_files_view;
        DROP VIEW IF EXISTS moorings_all_map;
        CREATE VIEW moorings_all_map AS
          SELECT
            -- file info
            m.file_id,
            i.url,
            m.date_created,
            i.first_indexed as date_published,
            i.last_indexed as date_updated,
            i.size,
            m.feature_type,
            m.file_version,
            m.toolbox_version,
            m.toolbox_input_file,
            m.compliance_checker_version,
            m.compliance_checks_passed,
            m.realtime,
            -- time/location
            m.site_code,
            m.platform_code,
            m.deployment_code,
            m.data_category,
            m.instrument,
            m.instrument_serial_number,
            m.instrument_nominal_depth,
            m.time_deployment_start,
            m.time_deployment_end,
            m.time_coverage_start,
            m.time_coverage_end,
            m.latitude,
            m.longitude,
            -- measured parameters
            m.standard_names ~ 'sea_[a-z_]*_temperature' AS water_temperature_b,
            m.standard_names ~ 'air_temperature' AS air_temperature_b,
            m.standard_names ~ 'sea_[a-z_]*_salinity' AS salinity_b,
            m.standard_names ~ 'sea_[a-z_]*_pressure' AS water_pressure_b,
            m.standard_names ~ 'air_pressure' AS air_pressure_b,
            m.standard_names ~ 'sea_water_velocity' AS sea_water_velocity_b,
            m.standard_names ~ 'oxygen' AS oxygen_b,
            m.standard_names ~ 'chlorophyll' AS chlorophyll_b,
            m.standard_names ~ 'fluorescence' AS fluorescence_b,
            m.standard_names ~ 'sea_surface_wave' AS wave_parameters_b,
            -- geometry
            m.geom
          FROM indexed_file i JOIN file_metadata m ON m.file_id = i.id
          WHERE NOT m.deleted
        ;
      </sql>
    </changeSet>


    <changeSet author="talend" id="anmn_all_map" runOnChange="true">
      <sql>
        DROP VIEW IF EXISTS anmn_all_map;
        CREATE VIEW anmn_all_map AS
          SELECT * FROM moorings_all_map WHERE url~'ANMN' ;
      </sql>
    </changeSet>


    <changeSet author="talend" id="abos_all_map" runOnChange="true">
      <sql>
        DROP VIEW IF EXISTS abos_all_map;
        CREATE VIEW abos_all_map AS
          SELECT * FROM moorings_all_map WHERE url~'ABOS' ;
      </sql>
    </changeSet>


</databaseChangeLog>
